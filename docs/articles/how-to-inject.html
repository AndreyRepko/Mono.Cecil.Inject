<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>How to inject with Cecil.Inject </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="How to inject with Cecil.Inject ">
    <meta name="generator" content="docfx 2.29.1.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font/build/web/hack-subset.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope nav-horse" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="/">
              <span class="brand-icon d-inline-block align-middle">
              <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 671 569" version="1">
                <path class="horse-outline" d="M277 568c-2-2-1-3 5-13 6-12 9-20 10-30 0-9-2-19-5-27-6-10-22-23-30-23-10 0-37 12-53 23a85 85 0 0 0-31 32c-6 12-11 17-20 22-22 10-63 6-80-8-4-3-8-12-8-16l-2-8c-3-8-2-21 2-35 3-5 4-11 4-12 1-1-1-1-7-1-13 1-28 1-34-1-12-2-22-10-26-19-4-8-3-17 4-33 8-19 9-29 5-47-3-14-3-28 0-36 6-16 21-31 48-47l37-21a1048 1048 0 0 0 118-74c2-2 2-3 0-7-2-5-2-16 0-24s9-22 16-30a108 108 0 0 1 82-37c3 0 3 0 3-5 0-12 6-22 19-34 12-11 26-18 38-18 4-1 7 0 8 1 2 1 2 1 0 5l-1 4 7-4c11-8 20-12 32-17 9-3 11-4 12-2 1 1 0 11-3 21-1 4 3 1 9-9l7-10 2 3c2 4 3 4 6 1 7-7 22-15 46-22a1453 1453 0 0 0 36-10c1 1-2 4-5 7-6 8-14 18-14 20 0 1 2 2 11 2s11 0 13 2c1 1 1 1-3 3l-9 8-19 22 11-7c9-7 21-15 22-14s-6 13-11 20l-8 10-2 3 3-1 10-2c11-3 33-3 42 0 6 1 17 7 21 10 2 1 17-5 51-19 12-5 23-10 24-9l1 3c-1 7-21 50-31 65-7 11-17 22-25 28l-6 5c1 2 20 20 24 22l11 5 7 3c1 3-17 9-25 9-7 0-8 2-2 6a375 375 0 0 0 30 20c1 3-18 4-31 2l-8-2 4 7c8 12 14 30 17 52 4 19 5 32 5 33-1 1-6-4-12-10l-10-10 4 9c5 9 9 16 10 22 0 3 0 4-1 3-1 0-7-6-13-14-11-13-13-15-13-13 0 3 9 36 12 42 5 13 14 20 26 22l6 2c1 1-4 5-10 8-5 3-7 3-16 3h-10l6 8c8 9 11 13 13 21v9l-9-7c-9-9-15-13-15-12 0 2 4 10 9 16 6 9 12 13 24 17 6 2 6 2 0 5-12 8-21 9-31 6l-7-2 5 10c5 11 9 20 8 21l-5 1c-8-2-24 6-62 29a338 338 0 0 1-190 55c-42 1-50 2-70 11l-11 4-2-1zm30-20c11-3 24-4 48-4a357 357 0 0 0 193-56 276 276 0 0 1 55-28l-3-5c-8-14-18-39-22-59-4-15-5-22-7-55a973 973 0 0 0-5-47c-4-33-14-77-26-118l-3-13-10-4c-8-4-10-6-11-9l-1-3h17c19 2 26 1 32-3l12-13a190 190 0 0 1 78-59c2 0 4-2 4-3l-12 4a1016 1016 0 0 1-117 43c-2 0 0-3 7-7l6-4h-9c-8 0-12 0-11-2l22-6c21-6 35-10 36-12l-2-2c-12-5-38-5-57 0l-19 6c-12 6-12 5 2-8l13-13c3-3 3-3-11 6-16 11-29 17-29 13 0-2 8-12 32-37l10-13-10 2c-30 7-53 20-67 39-10 14-12 12-7-4 4-13 7-26 6-29-1-2-2 0-4 4-5 8-8 12-17 22-11 11-25 21-25 17l7-10c4-6 10-15 12-21 6-10 10-23 9-24s-4 1-7 3l-14 8c-18 11-32 22-43 35l-8 7-3-2c0-3 7-16 15-27l7-10c-1-1-6 1-11 4-21 11-35 26-37 42v6l-12 2c-37 5-67 24-80 50-6 12-7 20-6 36l1 8-4 4c-7 9-44 35-73 52l-66 36c-26 14-40 24-50 35-5 6-10 13-10 15l4-1c4-3 7-1 10 5 1 4 2 8 2 27-1 21-1 22-3 27l-9 12c-6 5-7 7-11 15-7 17-8 25-1 32 8 8 22 11 43 9s30-5 51-17l20-11c34-15 56-7 55 22 0 12-2 16-19 32-28 27-55 41-78 42l-10 1c0 2 6 6 10 8 14 6 36 9 50 6 9-2 17-5 21-10l9-13c8-16 26-31 51-44 34-17 71-22 103-13 16 5 38 4 58-3 31-10 83-44 118-78 26-25 31-36 32-64v-15c1-1 4 5 6 14 5 15 4 30-3 43-9 19-46 53-86 80-47 31-78 42-113 38-8 0-11-1-15-3-6-4-14-5-29-6-11-1-13 0-7 5 9 7 13 14 17 23 2 6 3 8 3 21-1 13-1 15-3 21-4 9-4 10-1 9l10-3zM66 407l-1-20c0-15 0-16 2-21 6-14 20-22 38-22 15 0 22 4 27 13 2 5 3 7 3 16s-1 10-3 14l-7 7a388 388 0 0 1-56 12c1-1 38-8 44-11 14-7 15-9 15-19-1-13-5-20-14-23-4-1-18 0-24 1-5 2-13 7-16 11-3 6-4 10-5 27 0 19-1 22-3 15zm106-44c0-2 14-12 25-17l15-9 24-13c2 0 0 2-7 8a94 94 0 0 1-26 17l-18 9-13 5zm350-84l-4-10c-6-16-16-30-32-47l-9-10c1-1 10 4 18 10 9 7 15 15 21 27 7 13 12 34 9 34l-3-4zm-157-13c-6-2-7-3-11-8-9-13-8-35 1-50 9-13 24-22 40-22l8 1c1 1 0 2-7 3-21 3-36 14-42 31-3 9-3 26 0 26l2-6c1-9 6-18 11-24 4-6 14-12 22-15 10-3 25-2 32 1l6 2c2-1 2-1 4 1 2 3 3 12 3 21-1 11-4 18-11 26-11 10-24 14-42 14l-16-1zm36-7c9-2 15-7 20-13 6-8 9-21 6-29-2-4-10-10-14-10h-3l4 4c12 9 12 24 0 36-7 6-14 9-22 9-14 0-23-8-25-23l-1-5-2 5c-2 5-5 21-4 24 3 5 27 7 41 2zm1-10c9-4 16-13 16-21 0-13-15-20-31-15-10 4-14 9-14 20 0 7 2 11 6 15 7 5 14 5 23 1zm53-22l2-8c3-7 3-23 1-29-1-6-17-21-25-26-27-16-69-15-98 3-5 3-5 1 0-4 9-8 25-15 39-18 11-1 29-1 39 1 21 5 39 17 47 32 5 8 8 19 8 27 0 7-1 7-5 15-5 6-8 9-8 7zm18-75l3-2c11-6 29-19 29-22 0-2-23 1-33 4l-8 5c-4 3-6 2-4-2l6-8 4-7c-1 0-8 6-13 14l-7 7c-2-1-1-9 2-30l3-20c0-1-4 3-7 9-4 8-7 17-8 29 0 8 0 8-2 7-3-3-2-20 1-29 4-13 16-27 21-25 1 0 1 7-2 28l-1 14 6-5c4-4 10-7 13-9 5-3 16-5 16-3l-6 6-9 8-2 4 3-1c11-2 18-3 25-2l8 2c3 3-7 14-17 21-9 6-21 10-21 7zm-90-22c-5-3-10-8-12-11-1-5 0-6 3-5 6 2 5 1-1-5l-7-7c2-4 17-3 26 2 11 5 11 5 10 3l-6-8c-3-3-5-6-4-7s8 0 13 3l13 10c4 5 7 7 7 6a436 436 0 0 0 5-11 298 298 0 0 1 1 18l-1 9-5-6c-4-6-15-16-16-15l4 6 3 7-12-4c-19-9-35-13-22-5l24 18c0 3-11 1-21-3-2-1-2 0 0 2 5 5 3 6-2 3zM91 521c1-1 0-15-1-16s-3-2-5-1h-4v8l1 10 9-1zm-14-10c0-8 0-9-2-11-4-3-4-2-4 7 0 8 1 13 5 13l1-9zm26 7l4-2-3-14h-5l-4 1v6c0 6 1 10 3 10l5-1zm16-7c7-4 8-5 5-11l-3-6c-1-1-11 4-12 5s0 4 1 7l3 6c0 2 0 2 6-1zm19-12l7-6-5-12-15 10 6 12 7-4zm-42-4c6-1 17-6 27-12 17-10 47-35 47-38s-4-5-8-7c-9-2-22 3-47 16l-23 12c-7 3-9 3-11 7-6 10-6 21 1 23 4 1 7 1 14-1zm60-11l5-5-5-10-6 5-6 5 3 5 3 4 6-4zm13-13v-6c-2-4-3-4-7-1-2 2-2 3 0 7 3 3 4 3 7 0zm4-10c2-5 0-8-3-5-2 2-2 4-1 5 2 2 4 2 4 0zm455-28v-2c-7-4-11-8-15-14-5-7-11-22-13-28 0-3 0-4 2-4l7 3c6 3 7 3 5 0l-20-24c-1-2-1-2 13 2 9 4 24 6 24 4l-3-3c-11-6-18-20-23-43a238 238 0 0 0-12-45l12 8c7 6 7 6 0-8-2-5-4-9-3-10s12 7 20 15l8 7c1-1-4-23-7-33-4-16-10-27-21-40l-5-7c0-1 3-1 21 3 12 3 16 3 11 0a506 506 0 0 1-32-25c0-1 2-2 16-2h15c-1-2-23-23-26-24-2-2-3-1-10 1-11 5-21 6-31 5l-9-1 2 9a845 845 0 0 1 28 161c2 40 5 56 12 77 4 11 6 13 17 17 8 3 15 3 17 1zM26 397c5-6 6-8 6-31 0-21-1-23-2-25-2-2-3-2-6 0-7 3-7 8-3 28a117 117 0 0 1 2 29l3-1zm558-239c19-7 36-21 49-41 8-12 22-39 20-39l-7 11c-19 39-33 52-64 59a221 221 0 0 1-43 6l21 6c5 1 19 0 24-2zm3-16c17-5 30-14 39-27l18-32c-1-1-21 11-33 20s-26 24-38 40c-2 2 4 2 14-1zM452 57c9-9 27-19 43-24 7-2 8-2 9-5l5-8c2-2 3-5 2-5l-16 5c-21 6-35 13-42 20-5 5-6 5-6 9l-1 9 1 3 5-4z"></path>
                <path class="horse-face" d="M422 32c-14 8-28 16-41 26-11 8-20 19-30 28-4-1-1-6 0-9 5-10 13-19 19-30-1-2-4 1-6 1-17 8-35 21-41 40l-2 11c-30 3-61 14-81 37a61 61 0 0 0-16 47v12c-9 11-21 18-32 27-34 24-71 44-108 64-22 13-47 25-61 47-1 1-2 5 1 4s6-3 9 0c6 7 3 17 4 25l-1 29c-4 13-18 19-22 31-3 9-7 18-3 27 5 9 14 13 24 14 17 1 34 0 50-5 22-9 42-25 66-29 11-3 24 1 29 12 4 7 2 16 2 25-2 8-10 14-16 21-21 19-44 38-73 43-6 1-12 0-17 2 1 4 5 6 8 8 13 6 28 8 43 8 11-1 23-4 31-12 7-9 11-20 19-28 20-20 45-33 72-41 18-5 38-6 57-3 14 3 27 6 41 5 24 0 47-10 68-23 35-20 67-45 94-74 13-12 18-30 19-47 1-6-1-12 1-18 5 9 7 20 8 30 0 16-7 30-17 41-31 35-69 63-110 85-20 11-42 19-65 18-10 0-21 0-31-5-11-4-23-5-34-5-2 1-4 2-2 3 8 8 16 17 20 28 3 6 1 14 2 21 0 6 0 13-3 18 0 4-3 7-2 10 4 1 9-2 13-2 21-5 42-3 63-4a341 341 0 0 0 163-48c23-13 44-27 68-36 3-1-1-4-1-6-16-29-25-61-28-94a910 910 0 0 0-36-198c-6-3-14-6-19-11-1-1-3-3-2-5 14 0 28 3 41 0 9-3 15-11 21-18 20-24 46-44 75-56 2 0 6-2 5-4-4-1-9 3-13 4-37 16-76 28-114 43-1 0-3 0-1-1 3-4 9-6 12-10-6-2-13 1-19-1 18-7 38-10 56-17 2-1 2-3 0-4-12-4-24-4-36-3-17 0-33 6-48 11-2 1 2-2 2-3 7-7 16-13 22-22l-6 3c-11 7-22 15-34 19-3 0 0-3 0-4 13-16 28-30 40-46 0-2-4 0-5 0-27 5-55 17-72 40-3 3-5 7-9 8-1-4 2-9 3-14 2-9 6-18 5-27-1-3-3 2-4 2-8 16-21 29-36 39-1 1-4 3-5 2 6-10 14-20 19-31 3-7 8-16 8-24l-1-1zm36 50c3 0 1 4 2 6 0 12-4 24-4 36 2 1 4-2 5-3 8-7 18-15 30-14l-4 4c-4 4-9 8-12 13h8c9-1 19-2 27 1 3 1-1 5-2 7-9 10-21 18-34 21l4-3c9-6 19-12 27-21 2-2-3-2-4-2-14 1-28 3-39 10-1 1-3 2-2 0l11-17c-2-1-4 3-6 4l-15 16c-2-1 0-5 0-7l6-42c-1-2-4 1-4 2-8 11-11 24-12 37l-1 6a52 52 0 0 1 17-53l2-1zm-64 10c11 1 19 10 27 17 2 1 4 5 5 1 1-3 2-7 4-9 1 8 0 16-1 24-6-7-11-14-19-19-2 1 1 3 1 4l4 9c-10-3-19-9-29-12-2-1-6-3-9-1 0 2 4 3 6 5 8 6 16 11 22 18-7 0-14-3-21-4-1 2 3 4 4 6l-6-2c-5-4-10-8-11-14 2-2 6 2 7 0l-11-13c7-3 15-1 22 1l13 5c0-3-3-6-5-9-1-2-4-4-4-7h1zm-2 53c23 0 47 8 63 26 9 11 13 27 11 42-2 5-6 10-10 13 3-8 4-16 3-25 1-6 1-13-4-18-10-10-20-21-34-25a107 107 0 0 0-88 9l1-2a78 78 0 0 1 58-20zm4 42l7 1c-11 3-24 4-33 11a46 46 0 0 0-17 48c0 2 2 1 2-1 3-11 6-23 15-31 9-10 22-15 36-14 7-1 13 2 19 4 2 1 5-2 5 1 5 11 4 23 1 34-7 16-25 26-42 26-10 0-20 2-29-3-8-6-12-16-11-26-2-14 4-28 14-37 8-9 21-13 33-13zm83 25c8 4 16 11 23 17 13 15 20 33 24 52 0 1-1 3-1 1-6-11-10-23-18-34-8-13-19-24-29-36h1zM236 325c-12 12-27 21-43 28-7 3-13 8-20 10 4-6 10-8 16-12 15-9 30-19 46-26h1zm-131 20c8 0 17 0 23 7 5 6 6 13 6 20s0 14-5 18c-6 7-17 7-25 10l-35 7c-2 1-1 4-2 2-2-11-1-22-1-33-1-9 4-16 10-21 8-7 18-10 29-10z" fill="#f86e04"></path>
                <path class="horse-teeth-eye" d="M172 455c-2 0-3 1-4 3s1 3 2 4 3 1 4-1v-6h-2zm-6 6l-5 4-1 3 5 6c2 0 3-2 4-3l1-5-3-4-1-1zm-10 8l-4 3-8 6 3 7 3 4 4-2 7-7c1-2 0-3-1-5l-4-6zm-16 12l-6 3-9 7c-1 1 0 2 1 3l4 10 3-1 12-9v-3l-4-10h-1zm-19 13c-4 0-7 2-10 3l-3 3 4 12 2 2 8-4c2-1 4-3 4-5l-3-9-2-2zm-19 7l-8 2v3c1 4 0 9 3 13h3l7-2v-5c0-3-1-7-3-10l-2-1zm-17 2l-5 1 1 17s1 2 2 1l8-1 1-3-2-13c0-2-3-2-4-2h-1zm-13-5l-1 3v14c0 2 1 5 4 6l2-2v-15c0-3-2-5-4-6h-1z" fill="#fff"></path>
                <path class="horse-mane" d="M600 162c-10 2-20 7-31 6-6 1-12-1-17 1l6 26c13 46 19 94 23 142 3 29 4 59 16 87 4 6 12 7 18 9 5 1 10 3 14 0 0-3-4-4-6-6-11-9-17-24-22-37 0-1-1-4 2-4 4 1 8 4 12 4l-6-9-15-17c12 2 24 8 37 6 1-2-3-3-4-4-13-9-17-25-21-39l-13-48c6 3 11 9 17 12 2-2-1-5-1-6-2-5-6-10-6-15 6 2 10 7 15 11 4 3 7 8 12 10 1-2-1-5-1-8-3-20-8-41-20-57l-11-14c7-1 13 2 20 3 4 0 9 2 13 1 0-3-4-3-5-5l-28-21c-1-2 3-1 3-2 9-1 18 1 26-1 2-2-2-3-3-5l-22-20h-2z" fill="#e1cebe"></path>
                <path class="horse-outline" d="M652 79c-3 2-5 8-7 12-10 19-22 40-42 49-17 8-37 11-56 13-3 0-7-1-9 1 2 2 6 2 9 3 16 5 34 4 49-4 25-13 41-37 52-62 2-4 5-8 5-12h-1z"></path>
                <path class="horse-ears" d="M510 15c-15 4-30 9-44 16-7 3-14 8-18 14-2 5-2 11-2 17l7-5c13-13 31-19 48-25 5-4 6-10 10-14 0-1 1-3-1-3z" fill="#873c02"></path>
                <path class="horse-ears" d="M643 83c-11 4-20 11-29 18-16 11-29 26-41 42-2 2 2 2 3 2 22-3 42-16 53-35 5-9 11-17 15-27h-1z" fill="#8a3e03"></path>
                <path class="horse-teeth-eye" d="M411 207c-3 0 1 3 2 4 9 5 12 17 8 26-7 13-22 22-37 18-8-3-14-10-16-18-1-3 0-7-2-9-4 9-7 19-6 29 2 4 8 4 12 5 13 0 28 1 39-7 12-7 19-21 17-35-2-7-10-13-17-13z" fill="#fff"></path>
                <path class="horse-nose" d="M27 339c-2 0-5 1-7 3-3 2-3 6-3 9 0 9 3 18 4 26l1 21c0 2 2 2 3 1 3-2 5-5 6-8 2-5 1-10 2-15l-1-30c0-3-1-6-4-7h-1zm78 13c-6 0-11 0-16 2-6 2-11 5-14 9-4 4-5 9-6 14l-1 29h3l39-8 12-7c3-2 6-5 7-9l-1-13c-1-5-3-10-7-14-3-2-7-3-11-3h-5zm52 85c-14 1-25 7-37 13l-34 17c-5 2-8 8-9 14-2 4-2 9 1 13 3 5 10 4 15 3 12-3 22-9 33-15 14-9 27-19 39-30 3-2 6-4 6-7-1-5-6-7-10-8h-4z"></path>
              </svg>
              </span>
              <span class="align-middle">coder.horse</span>
              <span class="brand-marker">_</span>
              <span class="align-middle docs-text">Docs</span>
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="how-to-inject-with-cecilinject">How to inject with Cecil.Inject</h1>

<p>While Mono.Cecil exposes the contents of any managed .NET assembly and allows to edit everything in it, all the code injection must be done manually by adding IL insturctions into the method. Cecil.Inject attempts to simplify method injection by automating IL instruction editing and providing one-call methods to perform injections. In addition Cecil.Inject verifies every injection, so that no broken assemblies are created.</p>
<p>Cecil.Inject provides many ways to perform an injection, but they all contain the following steps:</p>
<ul>
<li>Define the injection method that follows the same structure as described in Injection flags.</li>
<li>Load the assemblies with the injection method and the injection target.</li>
<li>Get <strong>MethodDefiniton</strong> for the injection target and the injection method with <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetMethod_">GetMethod</a> (or others).</li>
<li>Create an instance of InjectionDefinition specifying the methods and additional settings.</li>
<li>Call <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html#Mono_Cecil_Inject_InjectionDefinition_Inject_">Inject</a>.</li>
</ul>
<p>In this chapter we will take a look at all the ways the injection can be performed.</p>
<div class="NOTE"><h5>Note</h5><p>Be sure to check the Injection flags chapter to understand how to specify the right injection flags.</p>
</div>
<h2 id="method-1-the-traditional-way">Method 1: The traditional way</h2>
<p>This is the most basic way to inject methods. Here, we simply follow the steps described above. For the sake of example, let us consider class <code>Bar</code> with method <code>Foo(int v1, bool v2)</code>. In this example, we want to inject it with the hook method that will receive the parameters of the method and the invoking instance of Bar.</p>
<h4 id="do-the-following">Do the following</h4>
<p>Create an assembly with the hook method that follows the structure introduced in the chapter <a href="injection-flags.html">Injection flags</a>.</p>
<p>In our hook assembly we define a static class <code>MyHookClass</code> with the hook method in it:</p>
<pre><code class="lang-csharp">namespace HookNamespace
{
    public static class MyHookClass 
    {
        public static void MyHook(Bar self, int v1, bool v2)
        {
            // Write hook&#39;s code here
        }
    }
}
</code></pre><p>Note that the class with the hook methods in it does not have to be static, but it advised to have it set to static.</p>
<p>Next, create a patcher and load the hook assembly along with the assembly that is to be patched.</p>
<p>In this example we create a <code>Patcher</code> class method Patch in it. Firstly, we will use <a class="xref" href="../api/Mono.Cecil.Inject.AssemblyLoader.html#Mono_Cecil_Inject_AssemblyLoader_LoadAssembly_">LoadAssembly</a> to load the needed assemblies. The structure of the <code>Patcher</code> class is thus the following:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Next steps...
    }
}
</code></pre><p>Next, we update our <code>Patch</code> method by getting the hook and the target. We do that by using <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetMethod_">GetMethod</a>, since we clearly don&#39;t have any conflicting overrides in our assemblies. The class now looks as follows:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Get the method definition for the injection definition
        MethodDefinition myHook = hookAssembly.MainModule.GetType(&quot;HookNamespace.MyHookClass&quot;).GetMethod(&quot;MyHook&quot;);
        // Get the method definition for the injection target. 
        // Note that in this example class Bar is in the global namespace (no namespace), which is why we don&#39;t specify the namespace.
        MethodDefinition foo = targetAssembly.MainModule.GetType(&quot;Bar&quot;).GetMethod(&quot;Foo&quot;);

        // Next steps...
    }
}
</code></pre><p>Finally, we can create the injector and perform the injection:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Get the method definition for the injection definition
        MethodDefinition myHook = hookAssembly.MainModule.GetType(&quot;HookNamespace.MyHookClass&quot;).GetMethod(&quot;MyHook&quot;);
        // Get the method definition for the injection target. 
        // Note that in this example class Bar is in the global namespace (no namespace), which is why we don&#39;t specify the namespace.
        MethodDefinition foo = targetAssembly.MainModule.GetType(&quot;Bar&quot;).GetMethod(&quot;Foo&quot;);

        // Create the injector
        InjectionDefinition injector = new InjectionDefinition(foo, myHook, InjectFlags.PassInvokingInstance | InjectFlags.passParametersVal);

        // Perform the injection with default settings (inject into the beginning before the first instruction)
        injector.Inject();

        // More injections or saving the target assembly...
    }
}
</code></pre><p><strong>Note the following:</strong></p>
<ul>
<li>The constructor for <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html">InjectionDefinition</a> requires the injection flags of the hook method. If the flags and the hook signature don&#39;t match, an exception will be thrown. For more information on how to specify the injection flags, refer to <a href="injection-flags.html">Injection flags</a>.</li>
<li>The constructor for <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html">InjectionDefinition</a> also takes addition parameters, like list of the fields and local variables to pass. Refer to the <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html#Mono_Cecil_Inject_InjectionDefinition__ctor_MethodDefinition_MethodDefinition_Mono_Cecil_Inject_InjectFlags_System_Int32___FieldDefinition___">constructor of InjectionDefinition</a>.</li>
</ul>
<p>After injecting you can either apply more injections or you can save the target assembly by using the <code>Write</code> methods found in <strong>AssemblyDefinition</strong> class.</p>
<h2 id="method-2-using-shortcut-methods">Method 2: Using shortcut methods</h2>
<p>Here, we look at how injections can be performed with a single method using the InjectWith. For the sake of example, let us consider class <code>Bar</code> with method <code>Foo(int v1, bool v2)</code>. In this example, we want to inject it with the hook method that will receive the parameters of the method and the invoking instance of <code>Bar</code>.</p>
<h4 id="do-the-following-1">Do the following</h4>
<p>Create an assembly with the hook method that follows the structure introduced in the chapter <a href="injection-flags.html">Injection flags</a>.</p>
<p>In our hook assembly we define a static class <code>MyHookClass</code> with the hook method in it:</p>
<pre><code class="lang-csharp">namespace HookNamespace
{
    public static class MyHookClass 
    {
        public static void MyHook(Bar self, int v1, bool v2)
        {
            // Write hook&#39;s code here
        }
    }
}
</code></pre><p>Note that the class with the hook methods in it does not have to be static, but it advised to have it set to static.</p>
<p>Then, create a patcher and load the hook assembly along with the assembly that is to be patched.</p>
<p>In this example we create a <code>Patcher</code> class with method <code>Patch</code> in it. Firstly, we will use <a class="xref" href="../api/Mono.Cecil.Inject.AssemblyLoader.html#Mono_Cecil_Inject_AssemblyLoader_LoadAssembly_">LoadAssembly</a> to load the needed assemblies. The structure of the <code>Patcher</code> class is thus the following:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Next steps...
    }
}
</code></pre><p>Next, we update our <code>Patch</code> method by getting the hook and the target. We do that by using <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetMethod_">GetMethod</a>, since we clearly don&#39;t have any conflicting overrides in our assemblies. The class now looks as follows:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Get the method definition for the injection definition
        MethodDefinition myHook = hookAssembly.MainModule.GetType(&quot;HookNamespace.MyHookClass&quot;).GetMethod(&quot;MyHook&quot;);
        // Get the method definition for the injection target. 
        // Note that in this example class Bar is in the global namespace (no namespace), which is why we don&#39;t specify the namespace.
        MethodDefinition foo = targetAssembly.MainModule.GetType(&quot;Bar&quot;).GetMethod(&quot;Foo&quot;);

        // Next steps...
    }
}
</code></pre><p>Finally, we can create the injector and perform the injection:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Get the method definition for the injection definition
        MethodDefinition myHook = hookAssembly.MainModule.GetType(&quot;HookNamespace.MyHookClass&quot;).GetMethod(&quot;MyHook&quot;);
        // Get the method definition for the injection target. 
        // Note that in this example class Bar is in the global namespace (no namespace), which is why we don&#39;t specify the namespace.
        MethodDefinition foo = targetAssembly.MainModule.GetType(&quot;Bar&quot;).GetMethod(&quot;Foo&quot;);

        // Perform the injection with default settings (inject into the beginning before the first instruction
        foo.InjectWith(myHook, flags: InjectFlags.PassInvokingInstance | InjectFlags.passParametersVal);

        // More injections or saving the target assembly...
    }
}
</code></pre><p><strong>Note the following:</strong></p>
<ul>
<li>The creation of an instance of <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html">InjectionDefinition</a> and injecting is done automatically within the <a class="xref" href="../api/Mono.Cecil.Inject.MethodDefinitionExtensions.html#Mono_Cecil_Inject_MethodDefinitionExtensions_InjectWith_">InjectWith</a> method.</li>
<li>The method requires the injection flags of the hook method. If the flags and the hook signature don&#39;t match, an exception will be thrown. For more information on how to specify the injection flags, refer to <a href="injection-flags.html">Injection flags</a>.</li>
<li>The method also takes additional parameters, like list of the fields and local variables to pass. Refer to the documentation of <a class="xref" href="../api/Mono.Cecil.Inject.MethodDefinitionExtensions.html#Mono_Cecil_Inject_MethodDefinitionExtensions_InjectWith_">InjectWith</a>.</li>
</ul>
<p>After injecting you can either apply more injections or you can save the target assembly by using the <code>Write</code> methods found in <strong>AssemblyDefinition</strong> class.</p>
<h2 id="method-3-automatically-create-injectors-for-multiple-targets">Method 3: Automatically create injectors for multiple targets</h2>
<p>This method is great for situations when there are multiple injection targets with varying method signatures and the goal is to hook them all to a single hook. In this case instead of explicitly creating the right injectors we can let Cecil.Inject figure out which hook fits the target best. This can be accomplished by using either <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetInjectionMethod_">GetInjectionMethod</a> or <a class="xref" href="../api/Mono.Cecil.Inject.MethodDefinitionExtensions.html#Mono_Cecil_Inject_MethodDefinitionExtensions_GetInjector_">GetInjector</a>.</p>
<p>In this example we consider the class <code>Bar</code> with methods <code>Foo(int v1, int v2)</code>, <code>Foo(int v1, long v2)</code> and <code>Foo(int v1, string v2)</code> and with field <code>int[] fArray</code>. The goal is to inject them with a hook method that will receive the <code>fArray</code> field and methods&#39; parameters. Unfortunately, since different overrides of Foo have different parameter types, it would require to go through each method and inject it separately. However, with Cecil.Inject, we can use the above-mentioned methods to automate injection.</p>
<h4 id="do-the-following-2">Do the following</h4>
<p>Create an assembly with the hook methods that follow the structure introduced in the chapter <a href="injection-flags.html">Injection flags</a>.</p>
<p>In our hook assembly we define a static class <code>MyHookClass</code> with the hook methods in it:</p>
<pre><code class="lang-csharp">namespace HookNamespace
{
    public static class MyHookClass 
    {
        public static void FooHook(ref int[] fArray, int v1, long v2)
        {
            // Write hook&#39;s code here
        }

        public static void FooHook(ref int[] fArray, int v1, int v2)
        {
            FooHook(ref fArray, v1, (long) v2);
        }

        public static void FooHook(ref int[] fArray, int v1, String v2)
        {
            FooHook(ref int[], v1, long.Parse(v2));
        }
    }
}
</code></pre><p>Note how all the hook logic is written only in one method, while other hooks simply call the first one. That way we need not write the same logic for all the hooks, and adding new hooks is really simple. If there were methods like <code>Foo(bool v1)</code>, we could simply rewrite the hook class by moving the hook logic to a separate method that would have all the parameters of other hook methods and make the hooks call that method instead.</p>
<p>Next, create a patcher and load the hook assembly along with the assembly that is to be patched.</p>
<p>In this example we create a <code>Patcher</code> class with method <code>Patch</code> in it. Firstly, we will use <a class="xref" href="../api/Mono.Cecil.Inject.AssemblyLoader.html#Mono_Cecil_Inject_AssemblyLoader_LoadAssembly_">LoadAssembly</a> to load the needed assemblies. The structure of the <code>Patcher</code> class is thus the following:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Next steps...
    }
}
</code></pre><p>Next, we update our <code>Patch</code> method to find all the method defintions for the <code>Foo</code> method and inject each one of them with the appropriate injection method. We do that by using <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetMethods_">GetMethods</a>, since we want to inject hooks into <strong>all</strong> the overrides of <code>Foo</code>. After that, we iterate through all the injection targets and create the injector with a suitable injection method (here we do it with <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetInjectionMethod_">GetInjectionMethod</a>, but it can be also done with <a class="xref" href="../api/Mono.Cecil.Inject.MethodDefinitionExtensions.html#Mono_Cecil_Inject_MethodDefinitionExtensions_GetInjector_">GetInjector</a>). Finally we preform the injection by using <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html#Mono_Cecil_Inject_InjectionDefinition_Inject_">Inject</a>. The class now looks as follows:</p>
<pre><code class="lang-csharp">using Mono.Cecil;
using Mono.Cecil.Inject;

public class Patcher
{    
    public void Patch()
    {
        // Load the assembly that contains the hook method
        AssemblyDefinition hookAssembly = AssemblyLoader.LoadAssembly(&quot;MyHookAssembly.dll&quot;);
        // Load the assembly
        AssemblyDefinition targetAssembly = AssemblyLoader.LoadAssembly(&quot;TargetAssembly.dll&quot;);

        // Get the type Bar
        // In this example Bar is in the global namespace, so we don&#39;t have to specify it
        TypeDefinition bar = targetAssembly.MainModule.GetType(&quot;Bar&quot;);
        // Get the type MyHookClass
        // Note how we have to specify the namespace
        TypeDefinition hooks = hookAssembly.MainModule.GetType(&quot;HookNamespace.MyHookClass&quot;);

        // Get all the overrides of method Foo
        MethodDefinition[] foos = bar.GetMethods(&quot;Foo&quot;);

        // Get the field definition of fArray
        FieldDefinition fArray = bar.GetField(&quot;fArray&quot;);

        foreach(MethodDefinition foo in foos)
        {
            // Find a suitable override of FooHook for an override of Foo and create an injector out of it
            InjectionDefinition injector = hooks.GetInjectionMethod(&quot;FooHook&quot;, foo, InjectFlags.PassFields | InjectFlags.PassParametersVal, null, fArray);
            // Perform the injection with default parameters (inject into the beginning before the first operation)
            // Since GetInjectionMethod can return null, we use the null-conditional operator (?) so that the Inject method is called only when injector is not null
            injector?.Inject();
        }

        // Perform other injections or save the modified assembly...
    }
}
</code></pre><p><strong>Note the following:</strong></p>
<ul>
<li>The usage of <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetInjectionMethod_">GetInjectionMethod</a> (or <a class="xref" href="../api/Mono.Cecil.Inject.TypeDefinitionExtensions.html#Mono_Cecil_Inject_TypeDefinitionExtensions_GetInjectionMethod_">GetInjectionMethod</a>, but it can be also done with <a class="xref" href="../api/Mono.Cecil.Inject.MethodDefinitionExtensions.html#Mono_Cecil_Inject_MethodDefinitionExtensions_GetInjector_">GetInjector</a>) requires the injection flags of the hook method. If the no injection methods with the specified flags are found, the methods simply return null. For more information on how to specify the injection flags, refer to <a href="injection-flags.html">Injection flags</a>.</li>
<li>The above-mentioned methods also take addition parameters, like list of the fields (which we used in this case) and local variables to pass. Refer to the <a class="xref" href="../api/Mono.Cecil.Inject.InjectionDefinition.html#Mono_Cecil_Inject_InjectionDefinition__ctor_">constructor of InjectionDefinition</a>.</li>
</ul>
<p>After injecting you can either apply more injections or you can save the target assembly by using the <code>Write</code> methods found in <strong>AssemblyDefinition</strong> class.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
